# ğŸ”— LangChain ì²´ì¸ ì•„í‚¤í…ì²˜

## ğŸ“Š í˜„ì¬ vs ê°œì„  ë¹„êµ

### âŒ í˜„ì¬ (langchain_llm.py) - ë‹¨ìˆœ Invoke

```python
# 1. í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ë¬¸ìì—´ë¡œ ì‘ì„±
system_prompt = """ë‹¹ì‹ ì€ í•œêµ­ì–´ ê±´ê°•/í• ì¼ ê´€ë¦¬ ë´‡ì˜ íŒŒì„œì…ë‹ˆë‹¤..."""
user_prompt = f"""ì‚¬ìš©ì ì…ë ¥: "{user_input}" ..."""

# 2. ë©”ì‹œì§€ ìˆ˜ë™ ìƒì„±
messages = [
    SystemMessage(content=system_prompt + "\n" + format_instructions),
    HumanMessage(content=user_prompt)
]

# 3. LLM í˜¸ì¶œ (invoke)
response = self.llm.invoke(messages)

# 4. ìˆ˜ë™ íŒŒì‹±
parsed = parser.parse(response.content)
```

**ë¬¸ì œì :**
- âŒ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì¬ì‚¬ìš© ë¶ˆê°€
- âŒ ì²´ì¸ ì—°ê²°ì´ ì—†ì–´ ë‹¨ê³„ê°€ ë¶„ë¦¬ë¨
- âŒ ì—ëŸ¬ ì²˜ë¦¬ê°€ ë¶„ì‚°ë¨
- âŒ ë””ë²„ê¹… ì–´ë ¤ì›€

---

### âœ… ê°œì„  (langchain_llm_v2.py) - LCEL ì‹œí€¸ì…œ ì²´ì¸

```python
# 1. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
self.intent_prompt_template = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(system_template),
    HumanMessagePromptTemplate.from_template(human_template)
])

# 2. ì‹œí€¸ì…œ ì²´ì¸ êµ¬ì„± (LCEL íŒŒì´í”„ ì—°ì‚°ì)
self.intent_chain = self.intent_prompt_template | self.llm | self.json_parser
#                   â†‘ í”„ë¡¬í”„íŠ¸              â†‘ LLM  â†‘ JSON íŒŒì„œ
#                   ë‹¨ê³„ 1                  ë‹¨ê³„ 2  ë‹¨ê³„ 3

# 3. ì²´ì¸ ì‹¤í–‰ (í•œ ë²ˆì˜ í˜¸ì¶œ)
parsed = self.intent_chain.invoke({"user_input": user_input})
```

**ì¥ì :**
- âœ… í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì¬ì‚¬ìš© ê°€ëŠ¥
- âœ… ì²´ì¸ì´ ìë™ìœ¼ë¡œ ë°ì´í„° ì „ë‹¬
- âœ… ì—ëŸ¬ ì²˜ë¦¬ í†µí•©
- âœ… ë””ë²„ê¹… ìš©ì´ (ê° ë‹¨ê³„ ì¶”ì )
- âœ… ë” ì„ ì–¸ì ì´ê³  ì½ê¸° ì‰¬ì›€

---

## ğŸ—ï¸ LCEL ì‹œí€¸ì…œ ì²´ì¸ êµ¬ì¡°

### ì˜ë„ íŒŒì‹± ì²´ì¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ ChatPromptTemplate (í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿)                      â”‚
â”‚                                                             â”‚
â”‚  Input: {"user_input": "7ì‹œê°„ ì¤ì–´"}                        â”‚
â”‚  â†“                                                          â”‚
â”‚  System: "ë‹¹ì‹ ì€ í•œêµ­ì–´ ê±´ê°•/í• ì¼ ê´€ë¦¬ ë´‡ì˜ íŒŒì„œì…ë‹ˆë‹¤..."      â”‚
â”‚  Human: "ì‚¬ìš©ì ì…ë ¥: '7ì‹œê°„ ì¤ì–´' ..."                       â”‚
â”‚  â†“                                                          â”‚
â”‚  Output: [SystemMessage(...), HumanMessage(...)]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ (íŒŒì´í”„)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ ChatOpenAI (LLM)                                         â”‚
â”‚                                                             â”‚
â”‚  Input: [SystemMessage(...), HumanMessage(...)]            â”‚
â”‚  â†“                                                          â”‚
â”‚  OpenAI API í˜¸ì¶œ (gpt-4o-mini)                              â”‚
â”‚  â†“                                                          â”‚
â”‚  Output: AIMessage(content='{"intent": "sleep", ...}')      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ (íŒŒì´í”„)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ JsonOutputParser (JSON íŒŒì‹±)                             â”‚
â”‚                                                             â”‚
â”‚  Input: AIMessage(content='{"intent": "sleep", ...}')       â”‚
â”‚  â†“                                                          â”‚
â”‚  JSON íŒŒì‹± (ìë™)                                            â”‚
â”‚  â†“                                                          â”‚
â”‚  Output: {"intent": "sleep", "entities": {...}, ...}        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**íŒŒì´í”„ ì—°ì‚°ì (`|`)**:
- ê° ë‹¨ê³„ì˜ ì¶œë ¥ì„ ë‹¤ìŒ ë‹¨ê³„ì˜ ì…ë ¥ìœ¼ë¡œ ìë™ ì „ë‹¬
- LangChainì´ íƒ€ì… ë³€í™˜ê³¼ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ìë™ ìˆ˜í–‰

---

## ğŸ“ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ êµ¬ì¡°

### 1. Intent Parsing Template

```python
system_template = """ë‹¹ì‹ ì€ í•œêµ­ì–´ ê±´ê°•/í• ì¼ ê´€ë¦¬ ë´‡ì˜ íŒŒì„œì…ë‹ˆë‹¤.
ì‚¬ìš©ì ì…ë ¥ì„ ë¶„ì„í•˜ì—¬ ì˜ë„ì™€ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.

ê°€ëŠ¥í•œ ì˜ë„(intent):
- sleep: ìˆ˜ë©´ (ì‹œê°„ ê³„ì‚° í•„ìš”ì‹œ ìë™ ê³„ì‚°)
- workout: ìš´ë™
- protein: ë‹¨ë°±ì§ˆ ì„­ì·¨
- weight: ì²´ì¤‘
- task_add: í• ì¼ ì¶”ê°€
- task_complete: í• ì¼ ì™„ë£Œ
- study: ê³µë¶€/í•™ìŠµ (ì‹œê°„ ê¸°ë¡)
- learning_log: í•™ìŠµ ê¸°ë¡ (ìƒˆë¡œìš´ ì§€ì‹/ìŠ¤í‚¬ ìŠµë“)
- summary: ìš”ì•½
- progress: ì§„í–‰ë„
- chat: ì¼ë°˜ ëŒ€í™”

ì˜ˆì‹œ:
- "7ì‹œê°„ ì¤ì–´" â†’ {{"intent": "sleep", "entities": {{"sleep_hours": 7}}, "confidence": 0.95}}
...

ë°˜ë“œì‹œ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”."""

human_template = """ì‚¬ìš©ì ì…ë ¥: "{user_input}"

ì´ ì…ë ¥ì„ ë¶„ì„í•˜ì—¬ JSONìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”."""
```

**ë³€ìˆ˜:**
- `{user_input}`: ì‚¬ìš©ì ì…ë ¥ì´ ìë™ìœ¼ë¡œ ì£¼ì…ë¨

**ì¥ì :**
- í”„ë¡¬í”„íŠ¸ë¥¼ í•œ ë²ˆ ì •ì˜í•˜ë©´ ëª¨ë“  ìš”ì²­ì— ì¬ì‚¬ìš©
- ë³€ìˆ˜ë§Œ ë°”ê¿”ì„œ invoke ê°€ëŠ¥
- í”„ë¡¬í”„íŠ¸ ë²„ì „ ê´€ë¦¬ ìš©ì´

---

### 2. Response Generation Template

```python
system_template = """ë‹¹ì‹ ì€ ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í—¬ìŠ¤ì¼€ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ê±´ê°• ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ê³  ë™ê¸°ë¶€ì—¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ë©°, ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•©ë‹ˆë‹¤.
í†¤: {tone}"""

human_template = """ì‚¬ìš©ì: "{user_input}"

ì²˜ë¦¬ ê²°ê³¼: {context}

ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” ì‘ë‹µì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”."""
```

**ë³€ìˆ˜:**
- `{user_input}`: ì‚¬ìš©ì ì…ë ¥
- `{context}`: ì²˜ë¦¬ ê²°ê³¼ (ì˜ˆ: "âœ“ ìˆ˜ë©´ ê¸°ë¡ ì™„ë£Œ: 7ì‹œê°„")
- `{tone}`: ì‘ë‹µ í†¤ (friendly, professional, casual)

---

### 3. Chat Template

```python
system_template = """ë‹¹ì‹ ì€ Horcrux, ì¹œê·¼í•œ ê±´ê°•/í• ì¼ ê´€ë¦¬ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì™€ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë©°, ê±´ê°• ê´€ë¦¬ë¥¼ ê²©ë ¤í•©ë‹ˆë‹¤.
í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ê³ , ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•©ë‹ˆë‹¤."""

human_template = "{user_input}"
```

**ë³€ìˆ˜:**
- `{user_input}`: ì‚¬ìš©ì ì…ë ¥

---

## ğŸ”§ ì²´ì¸ ì‚¬ìš© ì˜ˆì‹œ

### 1. ì˜ë„ íŒŒì‹±

```python
# ì´ˆê¸°í™” (í•œ ë²ˆë§Œ)
llm = LangChainLLM()

# ì²´ì¸ ì‹¤í–‰
result = llm.parse_intent("7ì‹œê°„ ì¤ì–´")
# â†’ {"intent": "sleep", "entities": {"sleep_hours": 7}, "confidence": 0.95, ...}
```

**ë‚´ë¶€ ë™ì‘:**
```python
# LCEL ì²´ì¸ì´ ìë™ìœ¼ë¡œ ìˆ˜í–‰:
{"user_input": "7ì‹œê°„ ì¤ì–´"}
â†“
í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì— ì£¼ì…
â†“
LLM í˜¸ì¶œ
â†“
JSON íŒŒì‹±
â†“
ê²°ê³¼ ë°˜í™˜
```

---

### 2. ì‘ë‹µ ìƒì„±

```python
response = llm.generate_response(
    user_input="7ì‹œê°„ ì¤ì–´",
    context="âœ“ ìˆ˜ë©´ ê¸°ë¡ ì™„ë£Œ: 7ì‹œê°„ +15 XP",
    tone="friendly"
)
# â†’ "ì˜í•˜ì…¨ì–´ìš”! 7ì‹œê°„ í‘¹ ì£¼ë¬´ì…¨ë„¤ìš”! ğŸ’¤ ..."
```

---

### 3. ì¼ë°˜ ëŒ€í™”

```python
response = llm.chat("ì•ˆë…•í•˜ì„¸ìš”!")
# â†’ "ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ê±´ê°• ê´€ë¦¬ëŠ” ì–´ë–»ê²Œ í•˜ê³  ê³„ì„¸ìš”? ğŸ˜Š"
```

---

## ğŸ“Š ê¸°ì¡´ vs LCEL ì„±ëŠ¥ ë¹„êµ

| í•­ëª© | ê¸°ì¡´ (Invoke) | LCEL ì²´ì¸ | ê°œì„  |
|------|---------------|-----------|------|
| **ì½”ë“œ ë¼ì¸ ìˆ˜** | ~160ì¤„ | ~240ì¤„ | +50% (í…œí”Œë¦¿ ì •ì˜ í¬í•¨) |
| **ì¬ì‚¬ìš©ì„±** | âŒ ë‚®ìŒ | âœ… ë†’ìŒ | í”„ë¡¬í”„íŠ¸ ì¬ì‚¬ìš© |
| **ê°€ë…ì„±** | âš ï¸ ë³´í†µ | âœ… ìš°ìˆ˜ | ì„ ì–¸ì  êµ¬ì¡° |
| **ìœ ì§€ë³´ìˆ˜** | âš ï¸ ì–´ë ¤ì›€ | âœ… ì‰¬ì›€ | í…œí”Œë¦¿ ë¶„ë¦¬ |
| **ë””ë²„ê¹…** | âŒ ì–´ë ¤ì›€ | âœ… ì‰¬ì›€ | ë‹¨ê³„ë³„ ì¶”ì  |
| **ì‘ë‹µ ì†ë„** | 1.59ì´ˆ | ~1.6ì´ˆ | ë™ì¼ |
| **ì •í™•ë„** | 100% | 100% | ë™ì¼ |

---

## ğŸ¯ LCELì˜ í•µì‹¬ ê°œë…

### 1. íŒŒì´í”„ ì—°ì‚°ì (`|`)

```python
chain = prompt | llm | parser
```

- Unix íŒŒì´í”„ì™€ ìœ ì‚¬í•œ ê°œë…
- ê° ë‹¨ê³„ì˜ ì¶œë ¥ â†’ ë‹¤ìŒ ë‹¨ê³„ì˜ ì…ë ¥
- íƒ€ì… ë³€í™˜ ìë™ ìˆ˜í–‰

---

### 2. Runnable ì¸í„°í˜ì´ìŠ¤

ëª¨ë“  LangChain ì»´í¬ë„ŒíŠ¸ëŠ” `Runnable` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„:

```python
# ê³µí†µ ë©”ì„œë“œ
runnable.invoke(input)       # ë™ê¸° ì‹¤í–‰
runnable.batch([input1, ...]) # ë°°ì¹˜ ì‹¤í–‰
runnable.stream(input)       # ìŠ¤íŠ¸ë¦¬ë° ì‹¤í–‰
```

---

### 3. ì²´ì¸ ì¡°í•©

```python
# ë³‘ë ¬ ì‹¤í–‰ (RunnableParallel)
from langchain_core.runnables import RunnableParallel

parallel_chain = RunnableParallel({
    "intent": intent_chain,
    "sentiment": sentiment_chain
})

# ì¡°ê±´ë¶€ ì‹¤í–‰ (RunnableBranch)
from langchain_core.runnables import RunnableBranch

conditional_chain = RunnableBranch(
    (lambda x: x["intent"] == "chat", chat_chain),
    (lambda x: x["intent"] == "sleep", sleep_chain),
    default_chain
)
```

---

## ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### 1. ê¸°ì¡´ ì½”ë“œ êµì²´

```bash
# ê¸°ì¡´ íŒŒì¼ ë°±ì—…
cp core/langchain_llm.py core/langchain_llm_old.py

# ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´
cp core/langchain_llm_v2.py core/langchain_llm.py
```

### 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
python3 tests/test_llm_only.py
```

### 3. ì›¹ ì„œë²„ ì¬ì‹œì‘

```bash
./run.sh web
```

---

## ğŸ“ˆ í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

### 1. Few-shot Learning

```python
# ì˜ˆì‹œë¥¼ í”„ë¡¬í”„íŠ¸ì— ë™ì  ì¶”ê°€
examples = [
    ("7ì‹œê°„ ì¤ì–´", {"intent": "sleep", ...}),
    ("30ë¶„ ìš´ë™í–ˆì–´", {"intent": "workout", ...}),
]

few_shot_template = FewShotChatMessagePromptTemplate(
    example_prompt=example_template,
    examples=examples
)
```

---

### 2. ë©”ëª¨ë¦¬ ì¶”ê°€

```python
from langchain.memory import ConversationBufferMemory

memory = ConversationBufferMemory()
chain_with_memory = RunnableWithMessageHistory(
    intent_chain,
    memory
)
```

---

### 3. ì—ì´ì „íŠ¸ ì²´ì¸

```python
# ì—¬ëŸ¬ ì—ì´ì „íŠ¸ë¥¼ ì²´ì¸ìœ¼ë¡œ ì—°ê²°
full_chain = (
    parse_chain        # 1. íŒŒì‹±
    | decision_chain   # 2. ì˜ì‚¬ê²°ì •
    | action_chain     # 3. í–‰ë™ ì‹¤í–‰
    | response_chain   # 4. ì‘ë‹µ ìƒì„±
)
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- **LangChain LCEL ê³µì‹ ë¬¸ì„œ**: https://python.langchain.com/docs/expression_language/
- **Prompt Templates**: https://python.langchain.com/docs/modules/model_io/prompts/
- **Output Parsers**: https://python.langchain.com/docs/modules/model_io/output_parsers/
- **Runnables**: https://python.langchain.com/docs/expression_language/interface

---

## ğŸ“ ê²°ë¡ 

### í˜„ì¬ ìƒíƒœ (langchain_llm.py)
- âœ… ì‘ë™í•¨
- âš ï¸ ì½”ë“œê°€ ì ˆì°¨ì 
- âš ï¸ ì¬ì‚¬ìš©ì„± ë‚®ìŒ

### LCEL ë²„ì „ (langchain_llm_v2.py)
- âœ… ë” ì„ ì–¸ì ì´ê³  ì½ê¸° ì‰¬ì›€
- âœ… í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì¬ì‚¬ìš©
- âœ… ì²´ì¸ í™•ì¥ ìš©ì´
- âœ… ë””ë²„ê¹… í¸ë¦¬

**ì¶”ì²œ:** LCEL ë²„ì „ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ì—¬ ì¥ê¸°ì  ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
